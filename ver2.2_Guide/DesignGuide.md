# PatentsFinder2.0 設計書

---

## 1. サービス概要

**PatentsFinder2.0**は、技術内容を入力することで関連する特許を検索・分析・解説できるWebアプリケーションです。ユーザーは日本語・英語で技術内容を入力し、詳細条件（IPCコード、国コード、出願人、公開日、キーワード）を指定することで、世界中の特許データベースから該当特許を抽出し、AIによる分析・要約を得ることができます。

---

## 2. 主な機能（詳細・具体例）

### 2.1. APIキー管理
- サイドバーでOpenAI APIキーとGoogle CloudサービスアカウントJSONを入力。
- 入力後、環境変数に保存し、セッション中は再入力不要。
- 認証情報が未設定の場合は、メイン画面で警告を表示し、検索機能を利用不可。
- APIキーの有効性チェックやエラー表示も行う。

### 2.2. 検索条件入力
- 技術内容（日本語・英語）をテキストエリアで入力。
- 詳細条件（IPCコード、国コード、出願人、公開日、キーワード）はフォームで個別入力。
- 公開日（From）はデフォルトで2020/1/1、Toは任意。
- キーワードはタイトル・要約・請求項に対する部分一致検索用。
- 入力値はすべて辞書型でワークフローに渡す。

### 2.3. 検索クエリ生成
- 技術内容をLLM（GPT-4等）に渡し、関連するIPCコード・キーワードを自動抽出。
- ユーザーが入力した詳細条件（IPCコード等）はLLM抽出結果とマージ。
- 検索クエリはSearchQueryオブジェクトとして管理。
- 検索条件のAND/OR結合は柔軟に制御。

### 2.4. 特許検索
- BigQueryの特許公開データセット（patents-public-data.patents.publications）に対してSQL検索。
- IPCコード・キーワードはOR条件でヒット件数を最大化。
- タイトル・要約・請求項に対してLOWER/LIKE句で部分一致検索。
- 公開日・国コード・出願人もパラメータ化して安全にフィルタ。
- 検索結果はDataFrameで取得し、最大100件まで表示。

### 2.5. 検索結果表示・ダウンロード
- 検索結果はStreamlitのdataframeで表形式表示。
- 検索結果が0件の場合はエラー表示。
- 検索結果はCSV形式でダウンロード可能。
- 検索条件やヒット件数も画面に明示。

### 2.6. 検索結果分析・類似度計算
- 検索結果のタイトル・要約・請求項をOpenAI Embeddingsでベクトル化。
- 入力技術内容も同様にベクトル化。
- コサイン類似度で各特許文献との関連度を数値化。
- 類似度上位N件（例：5件）を抽出し、ランキング表示。
- 類似度値も画面に表示。

### 2.7. 上位特許の要約・解説
- 類似度上位の特許について、LLMで要約・解説を生成。
- 要約は専門知識がない人にも分かるように簡潔に記述。
- 解説は技術的なポイントや新規性、応用例などを具体的に記述。
- 画面に解説を表示し、ユーザーが特許の内容を短時間で把握できるようにする。

---

## 3. システム構成

### 3.1. フロントエンド
- StreamlitによるWeb UI
- サイドバー：APIキー設定
- メイン画面：検索条件入力、検索結果表示、ダウンロード、要約表示

### 3.2. バックエンド
- Python（Streamlit, pandas, google-cloud-bigquery, OpenAI API）
- 検索クエリ生成：LLM（OpenAI GPT系）
- 特許検索：BigQuery SQL
- 類似度分析・要約：OpenAI Embeddings & Chat API

### 3.3. データベース
- Google BigQuery（patents-public-data.patents.publications）

---

## 4. 主要モジュール・ファイル構成

- src/app.py：Streamlitアプリ本体
- src/core/agent.py：検索クエリ生成、ワークフロー管理
- src/core/tools.py：BigQuery検索ロジック
- src/utils/config.py：APIキー・認証情報管理
- src/core/state.py：検索クエリ・状態管理

---

## 5. 検索・分析の仕組み（詳細・具体例）

### 5.1. 検索クエリ生成
- 技術内容＋詳細条件を受け取り、LLM（GPT-4等）でIPCコード・キーワードを抽出。
- ユーザー入力の詳細条件（IPCコード、国コード、出願人、公開日、キーワード）はLLM抽出結果とマージ。
- 検索クエリはSearchQueryオブジェクトとして統一管理。
- 検索条件の優先順位（ユーザー入力＞LLM抽出）を明確化。

### 5.2. BigQuery検索
- 検索クエリをもとにSQLを組み立て。
- IPCコード・キーワードはOR条件でヒット件数を最大化。
- タイトル・要約・請求項に対してLOWER/LIKE句で部分一致検索。
- 公開日・国コード・出願人もパラメータ化して安全にフィルタ。
- 検索結果は最大100件まで取得。
- SQL・クエリパラメータはデバッグ出力で確認可能。

### 5.3. 類似度分析
- 検索結果の各特許文献（タイトル＋要約＋請求項）をOpenAI Embeddingsでベクトル化。
- 入力技術内容も同様にベクトル化。
- コサイン類似度を計算し、入力内容と特許文献の関連度を数値化。
- 類似度上位N件（例：5件）を抽出し、ランキング表示。
- 類似度値も画面に表示。

### 5.4. 要約・解説生成
- 類似度上位特許のタイトル・要約・請求項をLLMに渡し、要約・解説を生成。
- 要約は専門知識がない人にも分かるように簡潔に記述。
- 解説は技術的なポイントや新規性、応用例などを具体的に記述。
- 画面に解説を表示し、ユーザーが特許の内容を短時間で把握できるようにする。

### 5.5. 結果表示・ダウンロード
- 検索結果（DataFrame）を画面に表示。
- CSV形式でダウンロード可能。
- 上位特許の要約・解説も画面に表示。
- 検索条件やヒット件数も画面に明示。

---

## 仕組みのポイント

- LLMによるクエリ生成：技術内容から自動で検索条件を抽出し、専門知識がなくても特許検索が可能。
- BigQueryによる高速検索：大量の特許データをクラウド上で高速に検索。
- AIによる分析・要約：検索結果の中から関連度の高い特許を抽出し、要約・解説を自動生成。
- 柔軟な検索条件：IPCコード・キーワード・公開日・国コード・出願人など多様な条件で絞り込み可能。
- ユーザー体験重視：検索・分析・解説までワンストップで完結し、結果はダウンロード可能。

---

この設計により、専門知識がなくても技術内容から関連特許を効率的に検索・分析・理解できるサービスとなります。
