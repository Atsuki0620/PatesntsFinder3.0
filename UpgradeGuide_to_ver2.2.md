
# UpgradeGuide_to_ver2.2.md

本ガイドはバージョン2.2へのアップグレードにおける設計・仕様案をまとめたものです。  
以下の内容はすべて「案」として記載しており、必ずしも記載通りの実装を強制するものではありません。実際の運用や現場状況に応じて適宜ご判断ください。

---

## A. APIキー設定の仕様案

**目的:**  
利用者ごとにAPIキーを切り替え可能とし、`.env`ファイルの編集を不要とする。

**仕様案:**  
- サイドバーにAPIキー入力欄を設置し、`setup_api_keys()`で各種キーを反映する。
- OpenAI APIキーは`os.environ["OPENAI_API_KEY"]`にセットする。
- GCPサービスアカウントのJSONは一時ファイル化し、そのパスを`GOOGLE_APPLICATION_CREDENTIALS`に設定する。
- 入力状況に応じて`st.success`や`st.warning`でフィードバックを表示する。
- **影響範囲:**  
    - `app.py`（UI拡張）
    - `utils.config`（設定ファイルの読み込み順見直し）

---

## B. 調査方針オブジェクト生成の仕様案

**目的:**  
ユーザー対話から自動で調査方針テキストを生成し、確認・編集可能にする。

**仕様案:**  
- LangGraphで対話履歴を解析し、自動生成した調査方針（200〜300字）を出力する。
- `st.text_area("調査方針（自動生成）")`でユーザー編集も許可する。
- 生成・編集後の調査方針は`AppState.plan_text`として保持し、検索ロジックへ引き渡す。

---

## C. 5案提示＆すり合わせプロンプトの仕様案

**目的:**  
ユーザーの意図や条件をより正確に引き出すため、調査方針を複数パターンで提示・選択・修正できるようにする。

**仕様案:**  
- CONTINUE_DIALOGUE_PROMPTを改修し、対話履歴から連想される調査方針を5パターン（技術・用途・IPC・狙いなど）列挙する。
- 各案の末尾に「1〜5で選択、合わなければ修正点を自由記述」と質問をつける。
- ワークフロー：
    1. `continue_dialogue`ノードで5案を出力。
    2. ユーザー選択内容を`AppState.selected_plan`に格納。
    3. `generate_query`で選択案と追記内容を統合し、検索条件を生成する。

---

## D. コサイン類似度計算の改良仕様案

**目的:**  
調査方針と文献情報の類似度判定をより精緻に行い、検索精度向上を図る。

**仕様案:**  
- 類似度計算は、  
    1. 片方は「確定調査方針（plan_text）」のEmbeddingを使用  
    2. もう片方は文献側の「タイトル」「要約」「請求項」の個別Embeddingを使用
- 「plan_text」Embeddingと各セクション（タイトル・要約・請求項）のEmbeddingごとにコサイン類似度を算出し、重み付け平均（score）を算出
- DataFrameに `sim_title` / `sim_abs` / `sim_claims` / `score` を追加し、scoreでソート
- UI上で行をクリックすると内訳詳細をモーダル表示（該当箇所ハイライトも含む）
- **備考:**
    - 重みはデフォルトでタイトル0.4、要約0.4、請求項0.2だが、UIスライダーで調整可能とする
    - タイトル・要約・請求項のいずれかが空でもスコア計算可能とする

---

## E. 今回は実装しない将来アイデア（備忘録）

- **パテントマップの可視化**  
  検索結果やIPC分類などを用いた特許の俯瞰・マッピング機能。特許群の技術分布や市場俯瞰を可視化できるUI。

- **検索履歴の保存**  
  検索条件・スコア・ユーザー操作ログなどを保存し、再利用や調査ノウハウの蓄積、レポート自動生成につなげる機能。

- **OpenAI APIを利用する工程の見直し・節約**  
  APIコスト低減のため、Embeddingや生成処理のキャッシュ化・事前計算、または低コストモデルへの切替等を検討する。

- **HyDE導入**  
  ユーザーの調査意図とEmbedding空間の一致度を高め、高精度・高満足度の特許レコメンドを実現する手法を検討。

- **RAGAsによる評価サイクルの導入**  
    1. 初回検索＋要約＋RAGAsスコア算出  
    2. RAGAs分析による検索方針アップデート（自動またはユーザー補助）  
    3. アップデートした検索方針で再検索（1回のみ）＋再スコア  
    4. 「1回で満足」or「さらに再実行したい場合は手動で」という運用

※上記の将来アイデアは今回のバージョンアップでは実装しませんが、今後の機能拡張や改善の参考案として記録します。

---
